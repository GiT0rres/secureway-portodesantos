<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureWay - Cadastro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="company-logo">SW</div>
                <div class="company-info">
                    <h1>SecureWay</h1>
                    <span class="company-badge">Cadastro de Usu√°rio</span>
                </div>
            </div>
            <nav class="header-nav">
                <button class="nav-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                    Menu
                </button>
                <button class="nav-btn" id="btnHome">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    In√≠cio
                </button>
                <button class="nav-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Perfil
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h2 class="page-title">Cadastro de Usu√°rio</h2>
                <p class="page-subtitle">Preencha suas informa√ß√µes para criar sua conta no SecureWay</p>
            </div>

            <div class="form-container">
                <form class="form-cadastro" id="formCadastro">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome">Nome Completo *</label>
                            <input type="text" id="nome" name="nome" placeholder="Ex: Jo√£o da Silva" required>
                        </div>

                        <div class="form-group">
                            <label for="email">E-mail *</label>
                            <input type="email" id="email" name="email" placeholder="Ex: joao@email.com" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="telefone">Telefone *</label>
                            <input type="tel" id="telefone" name="telefone" placeholder="Ex: (11) 98765-4321" maxlength="15" required>
                        </div>

                        <div class="form-group">
                            <label for="senha">Senha *</label>
                            <input type="password" id="senha" name="senha" placeholder="M√≠nimo 6 caracteres" required>
                        </div>
                    </div>

                     <div class="form-row">
                        <div class="form-group">
                            <label for="CPF">CPF *</label>
                            <input type="text" id="CPF" name="CPF" placeholder="Ex: 555.555.555-55" maxlength="14" required>
                        </div>

                        <div class="form-group">
                            <label for="RG">RG *</label>
                            <input type="text" id="RG" name="RG" placeholder="Ex: 12.345.678-9" maxlength="12" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="reset" class="btn-secondary">Limpar</button>
                        <button type="submit" class="btn-primary">Cadastrar</button>
                    </div>
                </form>

                <div class="footer-links">
                    <p>J√° possui uma conta? Fa√ßa o <a href="../Login/index.html">Login</a>.</p>
                    <p>Cadastre sua <a href="../CadastroEmpresa/index.html">empresa</a>.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Sucesso -->
    <div class="modal-overlay" id="modalSucesso">
        <div class="modal-content">
            <div class="modal-icon">‚úì</div>
            <h2 class="modal-title">Cadastro efetuado com sucesso!</h2>
            <p class="modal-text">Sua conta foi criada. Voc√™ ser√° redirecionado para o login.</p>
            <button class="modal-btn" id="btnComecar">Ir para Login</button>
        </div>
    </div>

    <script>
// Configura√É¬ß√É¬£o da API
const API_URL = 'http://localhost:3034/api';

// Aguarda o carregamento completo do DOM
document.addEventListener('DOMContentLoaded', function() {
    
    // Elementos
    const formCadastro = document.getElementById('formCadastro');
    const btnHome = document.getElementById('btnHome');
    const telefoneInput = document.getElementById('telefone');
    const cpfInput = document.getElementById('CPF');
    const rgInput = document.getElementById('RG');
    const nomeInput = document.getElementById('nome');
    const emailInput = document.getElementById('email');
    const senhaInput = document.getElementById('senha');
    const navBtns = document.querySelectorAll('.nav-btn');
    const modalSucesso = document.getElementById('modalSucesso');
    const btnComecar = document.getElementById('btnComecar');
    
    // ========================================
    // M√ÅSCARAS DE INPUT
    // ========================================
    
    // M√É¬°scara de Telefone (11) 98765-4321
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/\D/g, '');
            
            if (valor.length > 11) {
                valor = valor.slice(0, 11);
            }
            
            if (valor.length <= 11) {
                valor = valor.replace(/^(\d{2})(\d)/g, '($1) $2');
                valor = valor.replace(/(\d)(\d{4})$/, '$1-$2');
            }
            
            e.target.value = valor;
        });

        telefoneInput.addEventListener('blur', function() {
            const valor = this.value.replace(/\D/g, '');
            if (valor.length >= 10) {
                this.classList.add('valid');
                this.classList.remove('error');
            } else if (valor.length > 0) {
                this.classList.add('error');
                this.classList.remove('valid');
            }
        });

        telefoneInput.addEventListener('focus', function() {
            this.classList.remove('error');
        });
    }

    // M√É¬°scara de CPF (555.555.555-55)
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/\D/g, '');
            
            if (valor.length > 11) {
                valor = valor.slice(0, 11);
            }
            
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            
            e.target.value = valor;
        });

        cpfInput.addEventListener('blur', function() {
            const valor = this.value.replace(/\D/g, '');
            if (valor.length === 11 && validarCPF(valor)) {
                this.classList.add('valid');
                this.classList.remove('error');
            } else if (valor.length > 0) {
                this.classList.add('error');
                this.classList.remove('valid');
            }
        });

        cpfInput.addEventListener('focus', function() {
            this.classList.remove('error');
        });
    }

    // M√É¬°scara de RG (12.345.678-9)
    if (rgInput) {
        rgInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/\D/g, '');
            
            if (valor.length > 9) {
                valor = valor.slice(0, 9);
            }
            
            valor = valor.replace(/(\d{2})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d{1})$/, '$1-$2');
            
            e.target.value = valor;
        });

        rgInput.addEventListener('blur', function() {
            const valor = this.value.replace(/\D/g, '');
            if (valor.length >= 8) {
                this.classList.add('valid');
                this.classList.remove('error');
            } else if (valor.length > 0) {
                this.classList.add('error');
                this.classList.remove('valid');
            }
        });

        rgInput.addEventListener('focus', function() {
            this.classList.remove('error');
        });
    }

    // ========================================
    // VALIDA√á√ïES
    // ========================================
    
    // Valida√É¬ß√É¬£o do CPF
    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        
        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) {
            return false;
        }
        
        let soma = 0;
        let resto;
        
        for (let i = 1; i <= 9; i++) {
            soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
        }
        
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(9, 10))) return false;
        
        soma = 0;
        for (let i = 1; i <= 10; i++) {
            soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
        }
        
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(10, 11))) return false;
        
        return true;
    }

    // Valida√É¬ß√É¬£o do nome completo
    if (nomeInput) {
        nomeInput.addEventListener('blur', function() {
            const valor = this.value.trim();
            if (valor.length >= 3 && valor.includes(' ')) {
                this.classList.add('valid');
                this.classList.remove('error');
            } else if (valor.length > 0) {
                this.classList.add('error');
                this.classList.remove('valid');
            }
        });

        nomeInput.addEventListener('focus', function() {
            this.classList.remove('error');
        });
    }

    // Valida√É¬ß√É¬£o do e-mail
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            const valor = this.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (emailRegex.test(valor)) {
                this.classList.add('valid');
                this.classList.remove('error');
            } else if (valor.length > 0) {
                this.classList.add('error');
                this.classList.remove('valid');
            }
        });

        emailInput.addEventListener('focus', function() {
            this.classList.remove('error');
        });
    }

    // Valida√É¬ß√É¬£o da senha
    if (senhaInput) {
        senhaInput.addEventListener('blur', function() {
            const valor = this.value;
            
            if (valor.length >= 6) {
                this.classList.add('valid');
                this.classList.remove('error');
            } else if (valor.length > 0) {
                this.classList.add('error');
                this.classList.remove('valid');
            }
        });

        senhaInput.addEventListener('focus', function() {
            this.classList.remove('error');
        });
    }

    // ========================================
    // MODAL
    // ========================================
    
    function mostrarModal() {
        modalSucesso.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function esconderModal() {
        modalSucesso.classList.remove('show');
        document.body.style.overflow = '';
    }

    if (btnComecar) {
        btnComecar.addEventListener('click', function() {
            esconderModal();
            setTimeout(() => {
                window.location.href = '../Login/index.html';
            }, 300);
        });
    }

    if (modalSucesso) {
        modalSucesso.addEventListener('click', function(e) {
            if (e.target === modalSucesso) {
                esconderModal();
            }
        });
    }

    // ========================================
    // VERIFICAR DUPLICATAS NA API
    // ========================================
    async function verificarDuplicatas(email, cpf, rg, telefone) {
        try {
            console.log('üîç Verificando duplicatas...');
            
            const response = await fetch(`${API_URL}/users`);
            
            if (!response.ok) {
                throw new Error('Erro ao buscar usu√É¬°rios');
            }
            
            const usuarios = await response.json();
            console.log('üì• Total de usu√É¬°rios:', usuarios.length);
            
            const cpfLimpo = cpf.replace(/\D/g, '');
            const emailLower = email.toLowerCase();
            const rgLimpo = rg.replace(/\D/g, '');
            const telefoneLimpo = telefone.replace(/\D/g, '');
            
            // Verifica email duplicado
            const emailExiste = usuarios.find(u => u.email && u.email.toLowerCase() === emailLower);
            if (emailExiste) {
                return { 
                    duplicado: true, 
                    campo: 'email',
                    mensagem: 'Este e-mail j√° est√°¬° cadastrado no sistema!' 
                };
            }
            
            // Verifica telefone duplicado
            const telefoneExiste = usuarios.find(u => u.telefone && u.telefone === telefoneLimpo);
            if (telefoneExiste) {
                return { 
                    duplicado: true, 
                    campo: 'telefone',
                    mensagem: 'Este telefone j√° est√° cadastrado no sistema!' 
                };
            }
            
            // Verifica CPF duplicado
            const cpfExiste = usuarios.find(u => u.cpf && u.cpf === cpfLimpo);
            if (cpfExiste) {
                return { 
                    duplicado: true, 
                    campo: 'cpf',
                    mensagem: 'Este CPF j√° est√°¬° cadastrado no sistema!' 
                };
            }
            
            // Verifica RG duplicado
            const rgExiste = usuarios.find(u => u.rg && u.rg === rgLimpo);
            if (rgExiste) {
                return { 
                    duplicado: true, 
                    campo: 'rg',
                    mensagem: 'Este RG j√° est√° cadastrado no sistema!' 
                };
            }
            
            console.log('‚úÖ Nenhuma duplicata encontrada');
            return { duplicado: false };
            
        } catch (error) {
            console.error('‚ùå Erro ao verificar duplicatas:', error);
            throw error;
        }
    }

    // ========================================
    // CADASTRAR USU√ÅRIO NA API
    // ========================================
    async function cadastrarUsuario(dados) {
        try {
            console.log('üì§ Enviando para:', `${API_URL}/users`);
            console.log('üì¶ Dados:', dados);

            const response = await fetch(`${API_URL}/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dados)
            });

            const data = await response.json();
            console.log('üì• Resposta:', data);

            if (!response.ok) {
                return { success: false, error: data.error, status: response.status };
            }

            return { success: true, data };
        } catch (error) {
            console.error('‚ùå Erro na API:', error);
            return { success: false, error: error.message };
        }
    }
    
    // ========================================
    // ENVIO DO FORMUL√ÅRIO
    // ========================================
    if (formCadastro) {
        formCadastro.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Coleta os dados do formul√É¬°rio
            const nome = nomeInput.value.trim();
            const email = emailInput.value.trim();
            const telefone = telefoneInput.value.replace(/\D/g, '');
            const senha = senhaInput.value;
            const cpf = cpfInput.value.replace(/\D/g, '');
            const rg = rgInput.value.replace(/\D/g, '');
            
            // Valida√É¬ß√É¬µes
            let erros = [];
            
            if (nome.length < 3 || !nome.includes(' ')) {
                erros.push('Por favor, insira seu nome completo.');
                nomeInput.classList.add('error');
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                erros.push('Por favor, insira um e-mail v√É¬°lido.');
                emailInput.classList.add('error');
            }
            
            if (telefone.length < 10) {
                erros.push('Por favor, insira um telefone v√É¬°lido com DDD.');
                telefoneInput.classList.add('error');
            }
            
            if (senha.length < 6) {
                erros.push('A senha deve ter no m√É¬≠nimo 6 caracteres.');
                senhaInput.classList.add('error');
            }

            if (!cpf || cpf.length !== 11) {
                erros.push('Por favor, insira um CPF v√É¬°lido.');
                cpfInput.classList.add('error');
            } else if (!validarCPF(cpf)) {
                erros.push('CPF inv√É¬°lido.');
                cpfInput.classList.add('error');
            }

            if (!rg || rg.length < 8) {
                erros.push('Por favor, insira um RG v√É¬°lido (m√É¬≠nimo 8 d√É¬≠gitos).');
                rgInput.classList.add('error');
            }
            
            // Se houver erros, exibe alerta
            if (erros.length > 0) {
                alert('Por favor, corrija os seguintes erros:\n\n' + erros.join('\n'));
                return;
            }
            
            // Feedback visual no bot√É¬£o
            const btnEnviar = formCadastro.querySelector('.btn-primary');
            const textoOriginal = btnEnviar.textContent;
            
            btnEnviar.disabled = true;
            btnEnviar.textContent = '‚è≥ Verificando...';
            
            try {
                // Verifica duplicatas ANTES de cadastrar
                const verificacao = await verificarDuplicatas(email, cpf, rg, telefone);
                
                if (verificacao.duplicado) {
                    alert(`‚ùå ${verificacao.mensagem}\n\nCampo: ${verificacao.campo}\n\nPor favor, utilize informa√ß√µes diferentes.`);
                    
                    // Marca o campo com erro
                    if (verificacao.campo === 'email') {
                        emailInput.classList.add('error');
                    } else if (verificacao.campo === 'cpf') {
                        cpfInput.classList.add('error');
                    } else if (verificacao.campo === 'rg') {
                        rgInput.classList.add('error');
                    } else if (verificacao.campo === 'telefone') {
                        telefoneInput.classList.add('error');
                    }
                    
                    btnEnviar.textContent = textoOriginal;
                    btnEnviar.disabled = false;
                    return;
                }
                
                btnEnviar.textContent = '‚úì Cadastrando...';
                
                // Prepara os dados para enviar √É  API (COMO STRING!)
                const dadosAPI = {
                    nome: nome,
                    email: email,
                    telefone: telefone,  // STRING sem m√°scara
                    senha: senha,
                    cpf: cpf,           // STRING sem m√°scara
                    rg: rg              // STRING sem m√°scara
                };

                console.log('üìã Dados preparados:', dadosAPI);

                // Envia para a API
                const resultado = await cadastrarUsuario(dadosAPI);

                // Restaura o bot√É¬£o
                btnEnviar.textContent = textoOriginal;
                btnEnviar.disabled = false;

                if (resultado.success) {
                    console.log('‚úÖ Cadastro realizado com sucesso!', resultado.data);
                    
                    // Limpa o formul√É¬°rio
                    formCadastro.reset();
                    
                    // Remove classes de valida√É¬ß√É¬£o
                    document.querySelectorAll('.form-group input').forEach(input => {
                        input.classList.remove('valid', 'error');
                    });
                    
                    // Mostra o modal de sucesso
                    mostrarModal();
                    
                } else {
                    console.error('‚ùå Erro no cadastro:', resultado.error);
                    alert(`Erro ao cadastrar: ${resultado.error}`);
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('Erro ao processar cadastro. Verifique sua conex√É¬£o e tente novamente.');
                btnEnviar.textContent = textoOriginal;
                btnEnviar.disabled = false;
            }
        });
    }
    
    // Bot√É¬£o Home - volta para a p√É¬°gina principal
    if (btnHome) {
        btnHome.addEventListener('click', function() {
            window.location.href = '../index.html';
        });
    }
    
    // Navega√É¬ß√É¬£o dos bot√É¬µes
    navBtns.forEach((btn, index) => {
        btn.addEventListener('click', () => {
            if (btn.id !== 'btnHome') {
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                console.log('Navega√É¬ß√É¬£o alterada:', index);
            }
        });
    });
    
    console.log('‚úÖ SecureWay - Cadastro de Usu√É¬°rio carregado!');
    console.log('üì° API URL:', API_URL);
});
    </script>
</body>
</html>